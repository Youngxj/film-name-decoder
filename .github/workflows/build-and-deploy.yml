name: Build and Deploy

# è§¦å‘æ¡ä»¶
on:
  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main, master ]
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # Pull Request æ—¶è§¦å‘ï¼ˆä»…æ„å»ºï¼Œä¸éƒ¨ç½²ï¼‰
  pull_request:
    branches: [ main, master ]

# è®¾ç½®æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# å¹¶å‘æ§åˆ¶
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æ„å»ºä½œä¸š
  build:
    runs-on: ubuntu-latest
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout
      uses: actions/checkout@v4
      
    # è®¾ç½® Node.js ç¯å¢ƒ
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    # å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: npm ci
      
    # è¿è¡Œ ESLint æ£€æŸ¥
    - name: Run ESLint
      run: npm run lint
      continue-on-error: true
      
    # è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥
    - name: TypeScript check
      run: npx tsc --noEmit
      env:
        # ä»GitHub Secretsä¸­è·å–APIå¯†é’¥
        VITE_OMDB_API_KEY: ${{ secrets.VITE_OMDB_API_KEY }}

    # æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®
    - name: Debug environment
      run: |
        echo "æ£€æŸ¥ç¯å¢ƒå˜é‡è®¾ç½®..."
        echo "VITE_OMDB_API_KEY is set: ${{ secrets.VITE_OMDB_API_KEY != '' }}"
        # æ³¨æ„ï¼šä¸è¦ç›´æ¥è¾“å‡ºå¯†é’¥å€¼ï¼
      
    # æ„å»ºé¡¹ç›®
    - name: Build project
      run: npm run build
      env:
        # ä»GitHub Secretsä¸­è·å–APIå¯†é’¥
        VITE_OMDB_API_KEY: ${{ secrets.VITE_OMDB_API_KEY }}
        # è®¾ç½®åŸºç¡€è·¯å¾„ï¼Œé€‚ç”¨äº GitHub Pages
        VITE_BASE_PATH: ${{ github.event.repository.name != github.repository_owner.login && format('/{0}/', github.event.repository.name) || '/' }}
        
    # ä¸Šä¼ æ„å»ºäº§ç‰©
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-files
        path: dist/
        retention-days: 30
        
    # å¦‚æœæ˜¯ä¸»åˆ†æ”¯ï¼Œå‡†å¤‡ GitHub Pages éƒ¨ç½²
    - name: Setup Pages
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: actions/configure-pages@v4
      
    - name: Upload to GitHub Pages
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: actions/upload-pages-artifact@v3
      with:
        path: dist/

  # éƒ¨ç½²åˆ° GitHub Pagesï¼ˆä»…åœ¨ä¸»åˆ†æ”¯ï¼‰
  deploy:
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  # åˆ›å»º Releaseï¼ˆä»…åœ¨æ¨é€ tag æ—¶ï¼‰
  release:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist-files
        path: dist/
        
    # åˆ›å»ºå‹ç¼©åŒ…
    - name: Create release archive
      run: |
        cd dist
        zip -r ../film-name-decoder-${{ github.ref_name }}.zip .
        tar -czf ../film-name-decoder-${{ github.ref_name }}.tar.gz .
        
    # åˆ›å»º GitHub Release
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          film-name-decoder-${{ github.ref_name }}.zip
          film-name-decoder-${{ github.ref_name }}.tar.gz
        body: |
          ## ğŸ¬ å½±è§†æ–‡ä»¶åè§£æå™¨ ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          - `film-name-decoder-${{ github.ref_name }}.zip` - Windows ç”¨æˆ·æ¨è
          - `film-name-decoder-${{ github.ref_name }}.tar.gz` - Linux/macOS ç”¨æˆ·æ¨è
          
          ### ğŸš€ éƒ¨ç½²è¯´æ˜
          1. ä¸‹è½½å¯¹åº”çš„å‹ç¼©åŒ…
          2. è§£å‹åˆ° Web æœåŠ¡å™¨ç›®å½•
          3. è®¿é—® `index.html` å³å¯ä½¿ç”¨
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - æ™ºèƒ½è§£æå½±è§†æ–‡ä»¶å
          - IMDB ä¿¡æ¯æŸ¥è¯¢
          - å“åº”å¼è®¾è®¡
          - ç¦»çº¿å¯ç”¨
          
          ---
          **åœ¨çº¿ä½“éªŒ**: ${{ steps.deployment.outputs.page_url || format('https://{0}.github.io/{1}/', github.repository_owner, github.event.repository.name) }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}