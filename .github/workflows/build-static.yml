name: Build Static Files

# è§¦å‘æ¡ä»¶ - æ›´çµæ´»çš„è§¦å‘æ–¹å¼
on:
  # æŽ¨é€åˆ°ä»»ä½•åˆ†æ”¯æ—¶è§¦å‘
  push:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      deploy_to_pages:
        description: 'æ˜¯å¦éƒ¨ç½²åˆ° GitHub Pages'
        required: false
        default: 'false'
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    # è®¾ç½® Node.js çŽ¯å¢ƒ
    - name: ðŸ”§ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    # æ˜¾ç¤ºçŽ¯å¢ƒä¿¡æ¯
    - name: ðŸ“‹ æ˜¾ç¤ºçŽ¯å¢ƒä¿¡æ¯
      run: |
        echo "Node.js ç‰ˆæœ¬: $(node --version)"
        echo "npm ç‰ˆæœ¬: $(npm --version)"
        echo "åˆ†æ”¯: ${{ github.ref_name }}"
        echo "æäº¤: ${{ github.sha }}"
        
    # å®‰è£…ä¾èµ–
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        echo "æ­£åœ¨å®‰è£…é¡¹ç›®ä¾èµ–..."
        npm ci
        echo "ä¾èµ–å®‰è£…å®Œæˆï¼"
        
    # æž„å»ºé¡¹ç›®
    - name: ðŸ—ï¸ æž„å»ºé¡¹ç›®
      run: |
        echo "å¼€å§‹æž„å»ºé¡¹ç›®..."
        npm run build
        echo "æž„å»ºå®Œæˆï¼"
        echo "æž„å»ºäº§ç‰©å¤§å°:"
        du -sh dist/
        echo "æž„å»ºäº§ç‰©åˆ—è¡¨:"
        ls -la dist/
      env:
        # ä»ŽGitHub Secretsä¸­èŽ·å–APIå¯†é’¥
        VITE_OMDB_API_KEY: ${{ secrets.VITE_OMDB_API_KEY }}
        # æ ¹æ®æ˜¯å¦ä¸º GitHub Pages è®¾ç½®ä¸åŒçš„åŸºç¡€è·¯å¾„
        VITE_BASE_PATH: ${{ (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && format('/{0}/', github.event.repository.name) || './' }}
        
    # åˆ›å»ºæž„å»ºä¿¡æ¯æ–‡ä»¶
    - name: ðŸ“ åˆ›å»ºæž„å»ºä¿¡æ¯
      run: |
        cat > dist/build-info.json << EOF
        {
          "buildTime": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "gitCommit": "${{ github.sha }}",
          "gitBranch": "${{ github.ref_name }}",
          "buildNumber": "${{ github.run_number }}",
          "repository": "${{ github.repository }}",
          "workflow": "${{ github.workflow }}"
        }
        EOF
        echo "æž„å»ºä¿¡æ¯å·²åˆ›å»º:"
        cat dist/build-info.json
        
    # ä¸Šä¼ æž„å»ºäº§ç‰©
    - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: static-files-${{ github.run_number }}
        path: dist/
        retention-days: 90
        
    # åˆ›å»ºåŽ‹ç¼©åŒ…
    - name: ðŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        cd dist
        # åˆ›å»º ZIP åŽ‹ç¼©åŒ…
        zip -r ../film-name-decoder-static-${{ github.run_number }}.zip .
        # åˆ›å»º TAR.GZ åŽ‹ç¼©åŒ…
        tar -czf ../film-name-decoder-static-${{ github.run_number }}.tar.gz .
        cd ..
        echo "åŽ‹ç¼©åŒ…åˆ›å»ºå®Œæˆ:"
        ls -lh *.zip *.tar.gz
        
    # ä¸Šä¼ åŽ‹ç¼©åŒ…
    - name: ðŸ“¤ ä¸Šä¼ åŽ‹ç¼©åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: release-packages-${{ github.run_number }}
        path: |
          *.zip
          *.tar.gz
        retention-days: 90
        
    # è¾“å‡ºä¸‹è½½é“¾æŽ¥
    - name: ðŸ“‹ æž„å»ºå®Œæˆæ€»ç»“
      run: |
        echo "ðŸŽ‰ æž„å»ºå®Œæˆï¼"
        echo ""
        echo "ðŸ“¦ æž„å»ºäº§ç‰©:"
        echo "- é™æ€æ–‡ä»¶: static-files-${{ github.run_number }}"
        echo "- å‘å¸ƒåŒ…: release-packages-${{ github.run_number }}"
        echo ""
        echo "ðŸ”— ä¸‹è½½åœ°å€:"
        echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "ðŸ“ éƒ¨ç½²è¯´æ˜Ž:"
        echo "1. ä¸‹è½½ static-files æˆ– release-packages"
        echo "2. è§£åŽ‹åˆ° Web æœåŠ¡å™¨æ ¹ç›®å½•"
        echo "3. è®¿é—® index.html å³å¯ä½¿ç”¨"
        
  # å¯é€‰çš„ GitHub Pages éƒ¨ç½²
  deploy-pages:
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') || github.event.inputs.deploy_to_pages == 'true'
    needs: build
    runs-on: ubuntu-latest
    
    permissions:
      pages: write
      id-token: write
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
    - name: ðŸ“¥ ä¸‹è½½æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: static-files-${{ github.run_number }}
        path: dist/
        
    - name: ðŸ”§ é…ç½® GitHub Pages
      uses: actions/configure-pages@v4
      
    - name: ðŸ“¤ ä¸Šä¼ åˆ° GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: dist/
        
    - name: ðŸš€ éƒ¨ç½²åˆ° GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: ðŸŽ‰ éƒ¨ç½²å®Œæˆ
      run: |
        echo "ðŸš€ éƒ¨ç½²å®Œæˆï¼"
        echo "ðŸ”— è®¿é—®åœ°å€: ${{ steps.deployment.outputs.page_url }}"