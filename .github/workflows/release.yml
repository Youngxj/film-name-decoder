name: Release

# å½“åˆ›å»º Release æˆ–æ¨é€ Tag æ—¶è§¦å‘
on:
  release:
    types: [published]
  push:
    tags:
      - 'v*'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        type: string
      release_name:
        description: 'å‘å¸ƒåç§°'
        required: false
        type: string
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        default: false
        type: boolean

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    # è®¾ç½® Node.js ç¯å¢ƒ
    - name: ğŸ”§ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    # è·å–ç‰ˆæœ¬ä¿¡æ¯
    - name: ğŸ“‹ è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.tag_name }}"
          RELEASE_NAME="${{ github.event.inputs.release_name }}"
        elif [ "${{ github.event_name }}" = "push" ]; then
          VERSION="${GITHUB_REF#refs/tags/}"
          RELEASE_NAME="Release ${VERSION}"
        else
          VERSION="${{ github.event.release.tag_name }}"
          RELEASE_NAME="${{ github.event.release.name }}"
        fi
        
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "release_name=${RELEASE_NAME:-Release ${VERSION}}" >> $GITHUB_OUTPUT
        echo "å‘å¸ƒç‰ˆæœ¬: ${VERSION}"
        echo "å‘å¸ƒåç§°: ${RELEASE_NAME:-Release ${VERSION}}"
        
    # å®‰è£…ä¾èµ–
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci
      
    # æ›´æ–°ç‰ˆæœ¬å·
    - name: ğŸ”„ æ›´æ–°ç‰ˆæœ¬å·
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        # ç§»é™¤ v å‰ç¼€
        VERSION_NUMBER="${VERSION#v}"
        npm version $VERSION_NUMBER --no-git-tag-version
        echo "ç‰ˆæœ¬å·å·²æ›´æ–°ä¸º: $VERSION_NUMBER"
        
    # æ„å»ºé¡¹ç›®
    - name: ğŸ—ï¸ æ„å»ºé¡¹ç›®
      run: |
        echo "å¼€å§‹æ„å»ºå‘å¸ƒç‰ˆæœ¬..."
        npm run build
        echo "æ„å»ºå®Œæˆï¼"
      env:
        # ä»GitHub Secretsä¸­è·å–APIå¯†é’¥
        VITE_OMDB_API_KEY: ${{ secrets.VITE_OMDB_API_KEY }}
        VITE_BASE_PATH: './'
        
    # åˆ›å»ºå‘å¸ƒä¿¡æ¯æ–‡ä»¶
    - name: ğŸ“ åˆ›å»ºå‘å¸ƒä¿¡æ¯
      run: |
        cat > dist/release-info.json << EOF
        {
          "version": "${{ steps.version.outputs.version }}",
          "releaseName": "${{ steps.version.outputs.release_name }}",
          "buildTime": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "gitCommit": "${{ github.sha }}",
          "gitBranch": "${{ github.ref_name }}",
          "repository": "${{ github.repository }}",
          "downloadUrl": "https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
        }
        EOF
        
        # åˆ›å»º README æ–‡ä»¶
        cat > dist/README.txt << EOF
        å½±è§†æ–‡ä»¶åè§£æå™¨ ${{ steps.version.outputs.version }}
        =====================================
        
        ğŸ“¦ éƒ¨ç½²è¯´æ˜:
        1. å°†æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ åˆ° Web æœåŠ¡å™¨æ ¹ç›®å½•
        2. ç¡®ä¿æœåŠ¡å™¨æ”¯æŒé™æ€æ–‡ä»¶è®¿é—®
        3. è®¿é—® index.html å³å¯ä½¿ç”¨
        
        ğŸŒ åœ¨çº¿ä½“éªŒ:
        https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
        
        ğŸ“š é¡¹ç›®åœ°å€:
        https://github.com/${{ github.repository }}
        
        ğŸ·ï¸ ç‰ˆæœ¬ä¿¡æ¯:
        - ç‰ˆæœ¬å·: ${{ steps.version.outputs.version }}
        - æ„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - Git æäº¤: ${{ github.sha }}
        
        âœ¨ ä¸»è¦åŠŸèƒ½:
        - æ™ºèƒ½è§£æå½±è§†æ–‡ä»¶åä¿¡æ¯
        - æ”¯æŒ Scene å’Œ P2P å‘å¸ƒè§„èŒƒ
        - IMDB ç”µå½±ä¿¡æ¯æŸ¥è¯¢
        - å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨è®¾å¤‡
        - å®Œå…¨ç¦»çº¿å¯ç”¨
        
        ğŸ“‹ ç³»ç»Ÿè¦æ±‚:
        - ç°ä»£æµè§ˆå™¨ (Chrome 80+, Firefox 75+, Safari 13+, Edge 80+)
        - æ”¯æŒ JavaScript å’Œ CSS3
        - æ— éœ€æœåŠ¡å™¨ç«¯æ”¯æŒ
        EOF
        
    # åˆ›å»ºå‹ç¼©åŒ…
    - name: ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        # åˆ›å»ºä¸åŒæ ¼å¼çš„å‹ç¼©åŒ…
        cd dist
        
        # ZIP æ ¼å¼ (Windows å‹å¥½)
        zip -r "../film-name-decoder-${VERSION}.zip" .
        
        # TAR.GZ æ ¼å¼ (Linux/macOS å‹å¥½)
        tar -czf "../film-name-decoder-${VERSION}.tar.gz" .
        
        # 7Z æ ¼å¼ (é«˜å‹ç¼©ç‡)
        if command -v 7z &> /dev/null; then
          7z a "../film-name-decoder-${VERSION}.7z" .
        fi
        
        cd ..
        
        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        echo "å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ:"
        ls -lh film-name-decoder-${VERSION}.*
        
        # è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
        echo "æ–‡ä»¶å“ˆå¸Œå€¼:"
        if command -v sha256sum &> /dev/null; then
          sha256sum film-name-decoder-${VERSION}.* > checksums.txt
          cat checksums.txt
        fi
        
    # åˆ›å»ºæˆ–æ›´æ–° Release
    - name: ğŸš€ åˆ›å»º Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: ${{ steps.version.outputs.release_name }}
        draft: false
        prerelease: ${{ github.event.inputs.prerelease == 'true' }}
        files: |
          film-name-decoder-${{ steps.version.outputs.version }}.zip
          film-name-decoder-${{ steps.version.outputs.version }}.tar.gz
          film-name-decoder-${{ steps.version.outputs.version }}.7z
          checksums.txt
        body: |
          ## ğŸ¬ å½±è§†æ–‡ä»¶åè§£æå™¨ ${{ steps.version.outputs.version }}
          
          ### ğŸ“¥ ä¸‹è½½
          
          | æ–‡ä»¶ | é€‚ç”¨ç³»ç»Ÿ | è¯´æ˜ |
          |------|----------|------|
          | `film-name-decoder-${{ steps.version.outputs.version }}.zip` | Windows | ZIP æ ¼å¼ï¼ŒWindows ç”¨æˆ·æ¨è |
          | `film-name-decoder-${{ steps.version.outputs.version }}.tar.gz` | Linux/macOS | TAR.GZ æ ¼å¼ï¼ŒUnix ç³»ç»Ÿæ¨è |
          | `film-name-decoder-${{ steps.version.outputs.version }}.7z` | é€šç”¨ | 7Z æ ¼å¼ï¼Œæœ€é«˜å‹ç¼©ç‡ |
          | `checksums.txt` | é€šç”¨ | SHA256 æ ¡éªŒå’Œæ–‡ä»¶ |
          
          ### ğŸš€ å¿«é€Ÿéƒ¨ç½²
          
          1. **ä¸‹è½½å¯¹åº”çš„å‹ç¼©åŒ…**
          2. **è§£å‹åˆ° Web æœåŠ¡å™¨ç›®å½•**
          3. **è®¿é—® `index.html` å³å¯ä½¿ç”¨**
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          
          - ğŸ¯ **æ™ºèƒ½è§£æ** - è‡ªåŠ¨è¯†åˆ«å½±ç‰‡æ ‡é¢˜ã€å¹´ä»½ã€åˆ†è¾¨ç‡ç­‰ä¿¡æ¯
          - ğŸ¬ **IMDB é›†æˆ** - ä¸€é”®æŸ¥è¯¢ç”µå½±è¯¦ç»†ä¿¡æ¯å’Œè¯„åˆ†
          - ğŸ“± **å“åº”å¼è®¾è®¡** - å®Œç¾é€‚é…æ¡Œé¢å’Œç§»åŠ¨è®¾å¤‡
          - ğŸ” **é«˜çº§è¯†åˆ«** - æ”¯æŒ Scene å’Œ P2P å‘å¸ƒè§„èŒƒ
          - ğŸ’¾ **ç¦»çº¿å¯ç”¨** - æ— éœ€ç½‘ç»œè¿æ¥å³å¯è§£ææ–‡ä»¶å
          - ğŸ¨ **ç°ä»£ç•Œé¢** - ç¾è§‚çš„æš—è‰²ä¸»é¢˜å’Œæµç•…åŠ¨ç”»
          
          ### ğŸŒ åœ¨çº¿ä½“éªŒ
          
          **ç«‹å³ä½“éªŒ**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
          
          ### ğŸ“‹ æ›´æ–°å†…å®¹
          
          è¯·æŸ¥çœ‹ [æäº¤å†å²](https://github.com/${{ github.repository }}/commits/${{ steps.version.outputs.version }}) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
          
          ---
          
          **æ„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
          **Git æäº¤**: `${{ github.sha }}`  
          **é¡¹ç›®åœ°å€**: https://github.com/${{ github.repository }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    # è¾“å‡ºå®Œæˆä¿¡æ¯
    - name: ğŸ‰ å‘å¸ƒå®Œæˆ
      run: |
        echo "ğŸ‰ å‘å¸ƒå®Œæˆï¼"
        echo ""
        echo "ğŸ“¦ å‘å¸ƒç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
        echo "ğŸ”— Release åœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
        echo "ğŸŒ åœ¨çº¿ä½“éªŒ: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo ""
        echo "ğŸ“¥ ä¸‹è½½åœ°å€:"
        echo "- ZIP: https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/film-name-decoder-${{ steps.version.outputs.version }}.zip"
        echo "- TAR.GZ: https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/film-name-decoder-${{ steps.version.outputs.version }}.tar.gz"